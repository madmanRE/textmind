import streamlit as st
from core.pipline import analyze
import pandas as pd

st.title("üìä TextMind 1.0")

with st.expander("üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"):
    st.markdown(
        """
        #### ‚ùì FAQ: –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞
        
        **1. –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç–∞—Ä—Ç–µ?**  
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç:
        - —Å–≤–æ—é —Å—Ç—Ä–∞–Ω–∏—Ü—É,
        - —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏–∑ –¢–û–ü–∞,
        - —Å–ø–∏—Å–æ–∫ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
        
        ---
        
        **2. –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã?**  
        –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–∞—Ä—Å–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –≤—ã–¥–µ–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ –∑–æ–Ω–∞–º:
        - `title`  
        - `h1`  
        - `first_500_chars_after_h1`  
        - `text`  
        - `structures` (—Å–ø–∏—Å–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã)  
        - `slug`  
        - `subheadings`
        
        ---
        
        **3. –ö–∞–∫ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞?**  
        –î–ª—è –∫–∞–∂–¥–æ–π –∑–æ–Ω—ã —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–Ω–∞—è –º–æ–¥–µ–ª—å –≤—ã—á–∏—Å–ª—è–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —É—Å—Ä–µ–¥–Ω—ë–Ω–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ —Å –≤–µ–∫—Ç–æ—Ä–æ–º –∑–æ–Ω—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.  
        –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–Ω—è—Ç—å, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ –∫–∞–∂–¥–æ–π –∑–æ–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¢–û–ü—É.
        
        ---
        
        **4. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ?**  
        –ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º –∏ –∏—â–µ—Ç **—Å–∞–º—ã–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã** –≤ –∫–∞–∂–¥–æ–π –∑–æ–Ω–µ.
        
        ---
        
        **5. –ö–∞–∫ —Å—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã?**  
        –ö–∞–∂–¥—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –ø–æ —Ç—Ä—ë–º –º–µ—Ç—Ä–∏–∫–∞–º:
        - `keywords_sim` ‚Äî —Å—Ö–æ–¥—Å—Ç–≤–æ —Å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–º –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤,  
        - `my_doc_kw_sim` ‚Äî —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∑–æ–Ω—ã –∫–ª—é—á–∞–º,  
        - `my_doc_sim_zone` ‚Äî —Å—Ö–æ–¥—Å—Ç–≤–æ —Å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π –∑–æ–Ω–æ–π –º–æ–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞,  
        - `my_doc_sim_full` ‚Äî —Å—Ö–æ–¥—Å—Ç–≤–æ —Å –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –º–æ–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞.  
        
        –¢–∞–∫ –≤—ã—è–≤–ª—è—é—Ç—Å—è **—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑—Ä—ã–≤—ã**.
        
        ---
        
        **6. –ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏?**  
        –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ **LLM**, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
        
        """
    )

with st.form("analyze_form"):
    st.write("–ù–∞—Å—Ç—Ä–æ–π–∫–∏")

    my_domain = st.text_input("–ú–æ—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞")
    competitors = st.text_area("–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)")
    keywords = st.text_area("–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)")

    with st.expander("–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"):
        user_agent = st.text_input(
            "User-Agent",
            value="Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) "
                  "AppleWebKit/537.36 (KHTML, like Gecko) "
                  "Chrome/W.X.Y.Z Mobile Safari/537.36 "
                  "(compatible; Googlebot/2.1; +http://www.google.com/bot.html)"
        )

        expose_tags = st.text_area(
            "–ò—Å–∫–ª—é—á–∞–µ–º—ã–µ —Ç–µ–≥–∏ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)",
            value="\n".join([
                "script",
                "style",
                "noscript",
                "footer",
                "header",
                "nav"
            ])
        )

        temperatura = st.slider(
            "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏",
            min_value=0.0,
            max_value=2.0,
            value=1.0,
            step=0.1
        )

        struct = st.checkbox("–§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É")

    submitted = st.form_submit_button("–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å")

if submitted:
    my_domain = my_domain.strip()
    competitors = [c.strip() for c in competitors.splitlines() if c.strip()]
    keywords = [k.strip() for k in keywords.splitlines() if k.strip()]
    user_agent = user_agent.strip()
    exclude_tags_list = [tag.strip() for tag in expose_tags.splitlines() if tag.strip()]
    struct = struct

    with st.spinner("–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ..."):
        zone_relevance, semantics_gaps, results = analyze(my_domain, competitors, keywords, user_agent, exclude_tags_list, temperatura, struct)

    st.success("–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ")

    st.subheader("–ó–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¢–û–ü—É")
    df = pd.DataFrame.from_dict(zone_relevance, orient="index", columns=["relevance"])
    df = df.sort_values("relevance", ascending=True)
    st.bar_chart(df)

    st.subheader("–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑—Ä—ã–≤—ã")
    st.json(semantics_gaps)

    st.subheader("–ò—Ç–æ–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑")
    st.markdown(results, unsafe_allow_html=True)
